{% extends 'base.html.twig' %}

{% block title %}Dashboard - CVE Dashboard{% endblock %}

{% block body %}
<div class="min-h-screen w-full bg-gradient-to-br from-indigo-50 via-white to-purple-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-100">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-md">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">CVE Dashboard</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">Welcome, <strong class="text-gray-900">{{ user.name }}</strong></span>
                <a href="{{ path('app_logout') }}" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold px-4 py-2 rounded-xl shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Your CVE Monitoring</h2>
            <p class="text-gray-600">
                Tracking vulnerabilities for the last 30 days
                {% if startDate and endDate %}
                    ({{ startDate|date('M d, Y') }} - {{ endDate|date('M d, Y') }})
                {% endif %}
            </p>
        </div>

        {% if technologies is empty %}
            <!-- No Technologies Message -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-8 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl mb-4">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No Technologies Added</h3>
                <p class="text-gray-600 mb-6">You haven't added any technologies to monitor yet.</p>
                <a href="{{ path('app_logout') }}" class="inline-block bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                    Add Technologies
                </a>
            </div>
        {% else %}
            <!-- Tabs Container -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 bg-gray-50">
                    <nav class="flex overflow-x-auto">
                        {% for technology in technologies %}
                            <button
                                onclick="switchTab('{{ technology.name|replace({' ': '_'}) }}')"
                                id="tab-{{ technology.name|replace({' ': '_'}) }}"
                                class="tab-button px-6 py-4 text-sm font-semibold border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-300 transition-all duration-200 whitespace-nowrap
                                {% if loop.first %}active{% endif %}"
                            >
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                    </svg>
                                    <span>{{ technology.name }}</span>
                                    {% set cveCount = cvesByTechnology[technology.name]|default([])|length %}
                                    <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold rounded-full
                                        {% if cveCount > 0 %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-600{% endif %}">
                                        {{ cveCount }}
                                    </span>
                                </div>
                            </button>
                        {% endfor %}
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    {% for technology in technologies %}
                        <div
                            id="content-{{ technology.name|replace({' ': '_'}) }}"
                            class="tab-content {% if not loop.first %}hidden{% endif %}"
                        >
                            {% set cves = cvesByTechnology[technology.name]|default([]) %}

                            {% if cves is empty %}
                                <!-- No CVEs for this technology -->
                                <div class="text-center py-12">
                                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-2xl mb-4">
                                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 mb-2">No CVEs Found</h3>
                                    <p class="text-gray-600">No vulnerabilities found for {{ technology.name }} in the last 30 days.</p>
                                </div>
                            {% else %}
                                <!-- Summary Stats -->
                                <div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats-{{ technology.name|replace({' ': '_'}) }}">
                                        {% set stats = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0} %}
                                        {% for cve in cves %}
                                            {% if cve.severity and stats[cve.severity] is defined %}
                                                {% set stats = stats|merge({(cve.severity): stats[cve.severity] + 1}) %}
                                            {% endif %}
                                        {% endfor %}

                                        <div class="stat-card bg-red-50 border border-red-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all duration-200 hover:scale-105"
                                             data-severity="CRITICAL"
                                             data-technology="{{ technology.name|replace({' ': '_'}) }}"
                                             onclick="filterBySeverity('{{ technology.name|replace({' ': '_'}) }}', 'CRITICAL', this)">
                                            <div class="text-red-600 text-2xl font-bold">{{ stats.CRITICAL }}</div>
                                            <div class="text-red-700 text-sm font-semibold">Critical</div>
                                        </div>
                                        <div class="stat-card bg-orange-50 border border-orange-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all duration-200 hover:scale-105"
                                             data-severity="HIGH"
                                             data-technology="{{ technology.name|replace({' ': '_'}) }}"
                                             onclick="filterBySeverity('{{ technology.name|replace({' ': '_'}) }}', 'HIGH', this)">
                                            <div class="text-orange-600 text-2xl font-bold">{{ stats.HIGH }}</div>
                                            <div class="text-orange-700 text-sm font-semibold">High</div>
                                        </div>
                                        <div class="stat-card bg-yellow-50 border border-yellow-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all duration-200 hover:scale-105"
                                             data-severity="MEDIUM"
                                             data-technology="{{ technology.name|replace({' ': '_'}) }}"
                                             onclick="filterBySeverity('{{ technology.name|replace({' ': '_'}) }}', 'MEDIUM', this)">
                                            <div class="text-yellow-600 text-2xl font-bold">{{ stats.MEDIUM }}</div>
                                            <div class="text-yellow-700 text-sm font-semibold">Medium</div>
                                        </div>
                                        <div class="stat-card bg-blue-50 border border-blue-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all duration-200 hover:scale-105"
                                             data-severity="LOW"
                                             data-technology="{{ technology.name|replace({' ': '_'}) }}"
                                             onclick="filterBySeverity('{{ technology.name|replace({' ': '_'}) }}', 'LOW', this)">
                                            <div class="text-blue-600 text-2xl font-bold">{{ stats.LOW }}</div>
                                            <div class="text-blue-700 text-sm font-semibold">Low</div>
                                        </div>
                                    </div>
                                </div>
                                <!-- CVE List -->
                                <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar pt-6" id="cve-list-{{ technology.name|replace({' ': '_'}) }}">
                                    {% for cve in cves %}
                                        {% set cveStatus = userCVEMap[cve.cveId]|default({'checked': false, 'id': null}) %}
                                        {% set isChecked = cveStatus.checked %}
                                        {% set dbId = cve.id|default(cveStatus.id) %}
                                        <div class="cve-item bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl p-5 hover:shadow-md transition-all duration-200 cursor-pointer {{ isChecked ? 'opacity-50' : '' }}"
                                             data-severity="{{ cve.severity|default('UNKNOWN') }}"
                                             data-cve-id="{{ cve.cveId }}"
                                             data-db-id="{{ dbId }}"
                                             data-checked="{{ isChecked ? 'true' : 'false' }}"
                                             onclick="toggleCveCheck(event, '{{ cve.cveId }}', {{ dbId }}, this)">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex-1">
                                                    <h4 class="text-lg font-bold text-gray-900 mb-1">{{ cve.cveId }}</h4>
                                                    <div class="flex items-center space-x-3 text-sm text-gray-600">
                                                        <span class="flex items-center">
                                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                            </svg>
                                                            {{ cve.publishedDate ? cve.publishedDate|date('M d, Y') : 'N/A' }}
                                                        </span>
                                                        {% if cve.cvssScore %}
                                                            <span class="flex items-center">
                                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                                </svg>
                                                                Score: {{ cve.cvssScore }}
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% if cve.severity %}
                                                    <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold
                                                        {% if cve.severity == 'CRITICAL' %}bg-red-100 text-red-700 border border-red-200
                                                        {% elseif cve.severity == 'HIGH' %}bg-orange-100 text-orange-700 border border-orange-200
                                                        {% elseif cve.severity == 'MEDIUM' %}bg-yellow-100 text-yellow-700 border border-yellow-200
                                                        {% elseif cve.severity == 'LOW' %}bg-blue-100 text-blue-700 border border-blue-200
                                                        {% else %}bg-gray-100 text-gray-700 border border-gray-200{% endif %}">
                                                        {{ cve.severity }}
                                                    </span>
                                                {% endif %}
                                            </div>

                                            {% if cve.description %}
                                                <p class="text-gray-700 text-sm mb-3 leading-relaxed">{{ cve.description }}</p>
                                            {% endif %}

                                            {% if cve.url %}
                                                <a href="{{ cve.url }}" target="_blank" class="inline-flex items-center text-indigo-600 hover:text-indigo-700 font-semibold text-sm transition-colors duration-200">
                                                    View Details
                                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                    </svg>
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    let activeFilters = {};

    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active', 'text-indigo-600', 'border-indigo-600');
            button.classList.add('text-gray-600', 'border-transparent');
        });

        // Show selected tab content
        document.getElementById('content-' + tabName).classList.remove('hidden');

        // Add active class to selected tab
        const activeTab = document.getElementById('tab-' + tabName);
        activeTab.classList.add('active', 'text-indigo-600', 'border-indigo-600');
        activeTab.classList.remove('text-gray-600', 'border-transparent');
    }

    function filterBySeverity(technology, severity, element) {
        const cveList = document.getElementById('cve-list-' + technology);
        const allCves = cveList.querySelectorAll('.cve-item');
        const statsContainer = document.getElementById('stats-' + technology);
        const allStatCards = statsContainer.querySelectorAll('.stat-card');

        // Toggle filter: if clicking the same severity, clear the filter
        if (activeFilters[technology] === severity) {
            // Clear filter - show all CVEs
            activeFilters[technology] = null;
            allCves.forEach(cve => {
                cve.style.display = '';
            });

            // Remove active state from all stat cards
            allStatCards.forEach(card => {
                card.classList.remove('ring-4', 'ring-indigo-400', 'ring-opacity-50');
            });
        } else {
            // Apply filter - show only CVEs matching the severity
            activeFilters[technology] = severity;
            allCves.forEach(cve => {
                if (cve.dataset.severity === severity) {
                    cve.style.display = '';
                } else {
                    cve.style.display = 'none';
                }
            });

            // Remove active state from all stat cards
            allStatCards.forEach(card => {
                card.classList.remove('ring-4', 'ring-indigo-400', 'ring-opacity-50');
            });

            // Add active state to clicked stat card
            element.classList.add('ring-4', 'ring-indigo-400', 'ring-opacity-50');
        }
    }

    async function toggleCveCheck(event, cveIdString, dbId, element) {
        // Prevent click if user clicked on a link
        if (event.target.tagName === 'A' || event.target.closest('a')) {
            return;
        }

        event.preventDefault();

        try {
            const response = await fetch(`/dashboard/cve/toggle-check`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cveId: cveIdString,
                    dbId: dbId
                })
            });

            const data = await response.json();

            if (data.success) {
                element.dataset.checked = data.checked ? 'true' : 'false';
                element.dataset.dbId = data.dbId;

                if (data.checked) {
                    element.classList.add('opacity-50');
                } else {
                    element.classList.remove('opacity-50');
                }
            } else {
                console.error('Failed to toggle CVE check status');
            }
        } catch (error) {
            console.error('Error toggling CVE check:', error);
        }
    }

    // Initialize first tab as active
    document.addEventListener('DOMContentLoaded', function() {
        const firstTab = document.querySelector('.tab-button');
        if (firstTab) {
            firstTab.classList.add('text-indigo-600', 'border-indigo-600');
            firstTab.classList.remove('text-gray-600', 'border-transparent');
        }
    });
</script>

<style>
    .tab-button {
        position: relative;
    }

    .tab-button.active {
        color: #4f46e5;
        border-color: #4f46e5;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }
</style>
{% endblock %}
