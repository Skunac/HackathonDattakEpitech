<?php

namespace App\Controller;

use App\Entity\User;
use App\Entity\Technology;
use App\Service\DashboardService;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

class DashboardController extends AbstractController
{
    public function __construct(
        private EntityManagerInterface $entityManager,
        private DashboardService $dashboardService
    ) {
    }

    #[Route('/dashboard/{userId}', name: 'app_dashboard', methods: ['GET'])]
    public function index(int $userId, Request $request): Response
    {
        // 1. Récupérer l'utilisateur
        $user = $this->entityManager->getRepository(User::class)->find($userId);

        if (!$user) {
            throw $this->createNotFoundException('Utilisateur non trouvé');
        }

        // 2. Récupérer les technologies du user
        $technologies = $user->getTechnologies()->toArray();

        if (empty($technologies)) {
            // Pas de technos = pas de dashboard
            return $this->render('dashboard/no_technologies.html.twig', [
                'user' => $user,
            ]);
        }

        // 3. Récupérer la technologie sélectionnée (par défaut la première)
        $technologyId = $request->query->getInt('technology_id');

        $selectedTechnology = null;
        if ($technologyId) {
            $selectedTechnology = $this->entityManager->getRepository(Technology::class)->find($technologyId);

            // Vérifier que cette techno appartient bien au user
            if ($selectedTechnology && $selectedTechnology->getUser()->getId() !== $user->getId()) {
                throw $this->createAccessDeniedException('Cette technologie ne vous appartient pas');
            }
        }

        // Si pas de techno trouvée ou pas spécifiée, prendre la première
        if (!$selectedTechnology) {
            $selectedTechnology = $technologies[0];
        }

        // 4. Récupérer les filtres depuis l'URL
        $severityFilter = $request->query->all('severity'); // ex: ?severity[]=CRITICAL&severity[]=HIGH
        $statusFilter = $request->query->all('status'); // ex: ?status[]=TODO&status[]=

        // Convertir les valeurs vides ('') en null pour le filtre status
        $statusFilter = array_map(function($val) {
            return $val === '' ? null : $val;
        }, $statusFilter);

        // 5. Récupérer les CVE avec filtres
        $cves = $this->dashboardService->getAllCvesWithStatus(
            $user,
            $selectedTechnology,
            !empty($severityFilter) ? $severityFilter : null,
            !empty($statusFilter) ? $statusFilter : null
        );

        // 6. Récupérer les statistiques
        $stats = $this->dashboardService->getDashboardStatistics($user, $selectedTechnology);

        // 7. Render le template
        return $this->render('dashboard/index.html.twig', [
            'user' => $user,
            'technologies' => $technologies,
            'selectedTechnology' => $selectedTechnology,
            'cves' => $cves,
            'stats' => $stats,
            'currentFilters' => [
                'severity' => $request->query->all('severity'),
                'status' => $request->query->all('status'),
            ],
        ]);
    }
}
