<?php

namespace App\Service;

use App\Entity\Technology;
use App\Entity\User;
use App\Entity\Cve;
use App\Entity\UserCve;
use Doctrine\ORM\EntityManagerInterface;

class DashboardService
{
    public function __construct(
        private EntityManagerInterface $entityManager,
        private CveStorageService $cveStorageService,
        private KanbanService $kanbanService
    ) {
    }

    /**
     * Récupère toutes les CVE d'une technologie avec leur status
     * Pour affichage dans un tableau unique
     *
     * @param User $user
     * @param Technology $technology La technologie à afficher
     * @param array|null $severityFilter Filtrer par sévérité (ex: ['CRITICAL', 'HIGH'])
     * @param array|null $statusFilter Filtrer par status (ex: ['TODO', 'IN_PROGRESS', 'DONE', null])
     * @return array Liste de CVE avec leur status
     */
    public function getAllCvesWithStatus(
        User $user,
        Technology $technology,
        ?array $severityFilter = null,
        ?array $statusFilter = null
    ): array {
        // 1. Récupérer toutes les CVE de la technologie
        $allCves = [];
        foreach ($technology->getCves() as $cve) {
            $allCves[$cve->getId()] = $cve;
        }

        // 2. Récupérer les UserCVE (celles qui ont un status)
        $userCvesMap = [];
        foreach ($user->getUserCves() as $userCve) {
            $userCvesMap[$userCve->getCve()->getId()] = $userCve;
        }

        // 3. Construire le tableau final avec status
        $result = [];
        foreach ($allCves as $cve) {
            $userCve = $userCvesMap[$cve->getId()] ?? null;
            $status = $userCve ? $userCve->getStatus() : null;

            // Appliquer le filtre de sévérité
            if ($severityFilter !== null && !empty($severityFilter)) {
                if (!in_array($cve->getSeverity(), $severityFilter, true)) {
                    continue;
                }
            }

            // Appliquer le filtre de status
            if ($statusFilter !== null && !empty($statusFilter)) {
                // Si le filtre contient null, on inclut les CVE sans status
                $includeNull = in_array(null, $statusFilter, true);
                $hasMatchingStatus = $status !== null && in_array($status, $statusFilter, true);
                $hasNoStatus = $status === null && $includeNull;

                if (!$hasMatchingStatus && !$hasNoStatus) {
                    continue;
                }
            }

            $result[] = [
                'cve' => $cve,
                'status' => $status,
                'userCve' => $userCve,
                'addedAt' => $userCve ? $userCve->getAddedAt() : null,
                'updatedAt' => $userCve ? $userCve->getUpdatedAt() : null,
            ];
        }

        // 4. Trier par sévérité puis par score CVSS
        usort($result, function ($a, $b) {
            // Ordre de priorité des sévérités
            $severityOrder = [
                'CRITICAL' => 4,
                'HIGH' => 3,
                'MEDIUM' => 2,
                'LOW' => 1,
                'UNKNOWN' => 0,
            ];

            $severityA = $severityOrder[$a['cve']->getSeverity()] ?? 0;
            $severityB = $severityOrder[$b['cve']->getSeverity()] ?? 0;

            // Trier par sévérité d'abord
            if ($severityA !== $severityB) {
                return $severityB <=> $severityA;
            }

            // Puis par score CVSS
            return (float) $b['cve']->getCvssScore() <=> (float) $a['cve']->getCvssScore();
        });

        return $result;
    }

    /**
     * Récupère les statistiques d'une technologie spécifique
     *
     * @param User $user
     * @param Technology $technology
     * @return array
     */
    public function getDashboardStatistics(User $user, Technology $technology): array
    {
        // Stats des CVE de cette technologie
        $totalCves = $technology->getCves()->count();

        $bySeverity = [
            'CRITICAL' => 0,
            'HIGH' => 0,
            'MEDIUM' => 0,
            'LOW' => 0,
            'UNKNOWN' => 0,
        ];

        $cveIds = [];
        foreach ($technology->getCves() as $cve) {
            $cveIds[] = $cve->getId();
            $severity = $cve->getSeverity() ?? 'UNKNOWN';
            if (isset($bySeverity[$severity])) {
                $bySeverity[$severity]++;
            }
        }

        // Stats du Kanban pour cette technologie (CVE avec status)
        $byStatus = [
            'TODO' => 0,
            'IN_PROGRESS' => 0,
            'DONE' => 0,
        ];

        $totalWithStatus = 0;
        foreach ($user->getUserCves() as $userCve) {
            // Vérifier si cette UserCve concerne une CVE de cette technologie
            if (in_array($userCve->getCve()->getId(), $cveIds)) {
                $status = $userCve->getStatus();
                if (isset($byStatus[$status])) {
                    $byStatus[$status]++;
                    $totalWithStatus++;
                }
            }
        }

        return [
            'total_cves' => $totalCves,
            'by_severity' => $bySeverity,
            'by_status' => [
                'TODO' => $byStatus['TODO'],
                'IN_PROGRESS' => $byStatus['IN_PROGRESS'],
                'DONE' => $byStatus['DONE'],
                'NOT_STARTED' => $totalCves - $totalWithStatus, // CVE sans status
            ],
            'progress_percentage' => $totalWithStatus > 0
                ? round(($byStatus['DONE'] / $totalWithStatus) * 100, 2)
                : 0,
        ];
    }

    /**
     * Met à jour le status d'une CVE pour un utilisateur
     * Si la CVE n'a pas encore de status, elle est ajoutée au Kanban
     *
     * @param User $user
     * @param Cve $cve
     * @param string|null $newStatus Nouveau status (null pour retirer du Kanban)
     * @return UserCve|null
     */
    public function updateCveStatus(User $user, Cve $cve, ?string $newStatus): ?UserCve
    {
        // Chercher si une UserCVE existe déjà
        $userCve = $this->entityManager->getRepository(UserCve::class)->findOneBy([
            'user' => $user,
            'cve' => $cve,
        ]);

        // Si newStatus est null, on retire la CVE du Kanban
        if ($newStatus === null) {
            if ($userCve) {
                $this->kanbanService->removeCveFromKanban($userCve);
            }
            return null;
        }

        // Si la CVE n'existe pas encore dans le Kanban, on l'ajoute
        if (!$userCve) {
            return $this->kanbanService->addCveToKanban($user, $cve, $newStatus);
        }

        // Sinon on met à jour le status
        return $this->kanbanService->moveCve($userCve, $newStatus);
    }

    /**
     * Récupère les technologies d'un utilisateur avec le nombre de CVE associées
     *
     * @param User $user
     * @return array
     */
    public function getTechnologiesWithCveCount(User $user): array
    {
        $result = [];

        foreach ($user->getTechnologies() as $technology) {
            $cveCount = $technology->getCves()->count();

            // Compter par sévérité
            $bySeverity = [
                'CRITICAL' => 0,
                'HIGH' => 0,
                'MEDIUM' => 0,
                'LOW' => 0,
                'UNKNOWN' => 0,
            ];

            foreach ($technology->getCves() as $cve) {
                $severity = $cve->getSeverity() ?? 'UNKNOWN';
                if (isset($bySeverity[$severity])) {
                    $bySeverity[$severity]++;
                }
            }

            $result[] = [
                'technology' => $technology,
                'total_cves' => $cveCount,
                'by_severity' => $bySeverity,
            ];
        }

        return $result;
    }

    /**
     * Recherche des CVE par mot-clé dans la description ou le CVE ID
     *
     * @param User $user
     * @param Technology $technology
     * @param string $keyword
     * @param array|null $severityFilter
     * @param array|null $statusFilter
     * @return array
     */
    public function searchCves(
        User $user,
        Technology $technology,
        string $keyword,
        ?array $severityFilter = null,
        ?array $statusFilter = null
    ): array {
        $allCves = $this->getAllCvesWithStatus($user, $technology, $severityFilter, $statusFilter);

        $keyword = strtolower(trim($keyword));

        return array_filter($allCves, function ($item) use ($keyword) {
            $cve = $item['cve'];

            // Recherche dans le CVE ID
            if (str_contains(strtolower($cve->getCveId()), $keyword)) {
                return true;
            }

            // Recherche dans la description
            if (str_contains(strtolower($cve->getDescription()), $keyword)) {
                return true;
            }

            return false;
        });
    }
}
