<?php

namespace App\Service;

use Symfony\Contracts\HttpClient\HttpClientInterface;
use Psr\Log\LoggerInterface;

class CveFetcherService
{
    private const NVD_API_URL = 'https://services.nvd.nist.gov/rest/json/cves/2.0';
    private const RESULTS_PER_PAGE = 50;

    public function __construct(
        private HttpClientInterface $httpClient,
        private LoggerInterface $logger,
        private ?string $nvdApiKey = null
    ) {
    }

    /**
     */
    public function fetchCvesByKeyword(
        string $keyword,
        ?\DateTimeInterface $startDate = null,
        ?\DateTimeInterface $endDate = null,
        ?string $severity = null
    ): array {
        if (!$startDate) {
            $startDate = new \DateTime('-30 days');
        }
        if (!$endDate) {
            $endDate = new \DateTime('now');
        }

        $params = [
            'keywordSearch' => $keyword,
            'pubStartDate' => $startDate->format('Y-m-d\T00:00:00.000'),
            'pubEndDate' => $endDate->format('Y-m-d\T23:59:59.999'),
            'resultsPerPage' => self::RESULTS_PER_PAGE,
        ];

        if ($severity) {
            $params['cvssV3Severity'] = strtoupper($severity);
        }

        try {
            $this->logger->info('Fetching CVE from NVD', [
                'keyword' => $keyword,
                'startDate' => $startDate->format('Y-m-d'),
                'endDate' => $endDate->format('Y-m-d'),
            ]);

            $headers = [
                'Accept' => 'application/json',
            ];

            // Ajouter l'API key si disponible
            if ($this->nvdApiKey) {
                $headers['apiKey'] = $this->nvdApiKey;
                $this->logger->debug('Using NVD API key');
            }

            $response = $this->httpClient->request('GET', self::NVD_API_URL, [
                'query' => $params,
                'headers' => $headers,
                'timeout' => 30,
            ]);

            $statusCode = $response->getStatusCode();

            if ($statusCode !== 200) {
                $this->logger->error('NVD API returned non-200 status', [
                    'status' => $statusCode,
                    'response' => $response->getContent(false),
                ]);
                return [];
            }

            $data = $response->toArray();

            $this->logger->info('CVE fetched successfully', [
                'totalResults' => $data['totalResults'] ?? 0,
                'resultsReturned' => count($data['vulnerabilities'] ?? []),
            ]);

            return $this->parseCveData($data);

        } catch (\Exception $e) {
            $this->logger->error('Error fetching CVE from NVD', [
                'error' => $e->getMessage(),
                'keyword' => $keyword,
            ]);

            return [];
        }
    }

    private function parseCveData(array $data): array
    {
        $cves = [];

        if (!isset($data['vulnerabilities']) || !is_array($data['vulnerabilities'])) {
            return $cves;
        }

        foreach ($data['vulnerabilities'] as $item) {
            $cveData = $item['cve'] ?? null;

            if (!$cveData) {
                continue;
            }

            $description = $this->extractDescription($cveData);

            $metrics = $this->extractCvssMetrics($cveData);

            $url = $this->extractFirstReference($cveData);

            $publishedDate = null;
            if (isset($cveData['published'])) {
                try {
                    $publishedDate = new \DateTime($cveData['published']);
                } catch (\Exception $e) {
                    $this->logger->warning('Invalid published date', [
                        'cveId' => $cveData['id'] ?? 'unknown',
                        'date' => $cveData['published'],
                    ]);
                }
            }

            $cves[] = [
                'cveId' => $cveData['id'] ?? null,
                'description' => $description,
                'cvssScore' => $metrics['score'],
                'severity' => $metrics['severity'],
                'publishedDate' => $publishedDate,
                'url' => $url,
                'rawData' => $cveData,
            ];
        }

        return $cves;
    }

    private function extractDescription(array $cveData): ?string
    {
        $descriptions = $cveData['descriptions'] ?? [];

        foreach ($descriptions as $desc) {
            if (($desc['lang'] ?? '') === 'en' && !empty($desc['value'])) {
                return $desc['value'];
            }
        }

        return $descriptions[0]['value'] ?? null;
    }

    /**
     * Extrait les mÃ©triques CVSS v3.1 (ou v3.0 en fallback)
     */
    private function extractCvssMetrics(array $cveData): array
    {
        $metrics = $cveData['metrics'] ?? [];

        if (isset($metrics['cvssMetricV31']) && !empty($metrics['cvssMetricV31'])) {
            $cvss = $metrics['cvssMetricV31'][0]['cvssData'] ?? null;
            if ($cvss) {
                return [
                    'score' => $cvss['baseScore'] ?? null,
                    'severity' => $cvss['baseSeverity'] ?? null,
                ];
            }
        }

        if (isset($metrics['cvssMetricV30']) && !empty($metrics['cvssMetricV30'])) {
            $cvss = $metrics['cvssMetricV30'][0]['cvssData'] ?? null;
            if ($cvss) {
                return [
                    'score' => $cvss['baseScore'] ?? null,
                    'severity' => $cvss['baseSeverity'] ?? null,
                ];
            }
        }

        if (isset($metrics['cvssMetricV2']) && !empty($metrics['cvssMetricV2'])) {
            $cvss = $metrics['cvssMetricV2'][0]['cvssData'] ?? null;
            if ($cvss) {
                return [
                    'score' => $cvss['baseScore'] ?? null,
                    'severity' => $this->mapCvssV2Severity($cvss['baseScore'] ?? 0),
                ];
            }
        }

        return [
            'score' => null,
            'severity' => null,
        ];
    }

    private function mapCvssV2Severity(float $score): string
    {
        if ($score >= 9.0) return 'CRITICAL';
        if ($score >= 7.0) return 'HIGH';
        if ($score >= 4.0) return 'MEDIUM';
        return 'LOW';
    }

    private function extractFirstReference(array $cveData): ?string
    {
        $references = $cveData['references'] ?? [];

        if (!empty($references) && isset($references[0]['url'])) {
            return $references[0]['url'];
        }

        return null;
    }
    public function fetchMultipleTechnologies(
        array $keywords,
        ?\DateTimeInterface $startDate = null,
        ?\DateTimeInterface $endDate = null
    ): array {
        $results = [];

        $sleepTime = $this->nvdApiKey ? 1 : 7;

        foreach ($keywords as $keyword) {
            if (!empty($results)) {
                sleep($sleepTime);
            }

            $results[$keyword] = $this->fetchCvesByKeyword($keyword, $startDate, $endDate);
        }

        return $results;
    }
}
