<?php

namespace App\Command;

use App\Service\CveFetcherService;
use Symfony\Component\Console\Attribute\AsCommand;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Style\SymfonyStyle;

#[AsCommand(
    name: 'app:fetch-cve',
    description: 'Fetch CVE from NVD API for a given technology',
)]
class FetchCveCommand extends Command
{
    public function __construct(
        private CveFetcherService $cveFetcher
    ) {
        parent::__construct();
    }

    protected function configure(): void
    {
        $this
            ->addArgument('technology', InputArgument::REQUIRED, 'Technology keyword (ex: apache, php, nginx)')
            ->addOption('days', 'd', InputOption::VALUE_OPTIONAL, 'Number of days to look back', 30)
            ->addOption('severity', 's', InputOption::VALUE_OPTIONAL, 'Filter by severity (LOW, MEDIUM, HIGH, CRITICAL)')
            ->addOption('limit', 'l', InputOption::VALUE_OPTIONAL, 'Limit number of results displayed', 10)
        ;
    }

    protected function execute(InputInterface $input, OutputInterface $output): int
    {
        $io = new SymfonyStyle($input, $output);

        $technology = $input->getArgument('technology');
        $days = (int) $input->getOption('days');
        $severity = $input->getOption('severity');
        $limit = (int) $input->getOption('limit');

        $io->title('Fetching CVE for: ' . $technology);
        $io->info(sprintf('Looking for CVE from the last %d days', $days));

        if ($severity) {
            $io->info('Filtering by severity: ' . $severity);
        }

        // Calcul des dates
        $endDate = new \DateTime('now');
        $startDate = new \DateTime("-{$days} days");

        $io->section('Requesting NVD API...');

        // Fetch les CVE
        $cves = $this->cveFetcher->fetchCvesByKeyword(
            $technology,
            $startDate,
            $endDate,
            $severity
        );

        if (empty($cves)) {
            $io->warning('No CVE found for this technology in the specified period.');
            return Command::SUCCESS;
        }

        $io->success(sprintf('Found %d CVE!', count($cves)));

        // Affichage des résultats (limité)
        $displayCount = min($limit, count($cves));
        $io->section(sprintf('Displaying first %d results:', $displayCount));

        foreach (array_slice($cves, 0, $displayCount) as $index => $cve) {
            $io->writeln('');
            $io->writeln(sprintf('<fg=cyan>%d. %s</>', $index + 1, $cve['cveId']));
            $io->writeln(sprintf('   Severity: <fg=%s>%s</> (Score: %s)',
                $this->getSeverityColor($cve['severity']),
                $cve['severity'] ?? 'N/A',
                $cve['cvssScore'] ?? 'N/A'
            ));
            $io->writeln(sprintf('   Published: %s',
                $cve['publishedDate'] ? $cve['publishedDate']->format('Y-m-d H:i:s') : 'N/A'
            ));
            $io->writeln(sprintf('   Description: %s',
                $this->truncateText($cve['description'] ?? 'No description', 100)
            ));
            if ($cve['url']) {
                $io->writeln(sprintf('   URL: <href=%s>%s</>', $cve['url'], $cve['url']));
            }
        }

        if (count($cves) > $displayCount) {
            $io->note(sprintf('%d more CVE available. Use --limit to see more.', count($cves) - $displayCount));
        }

        // Statistiques
        $io->section('Statistics:');
        $stats = $this->calculateStats($cves);
        $io->table(
            ['Severity', 'Count'],
            [
                ['CRITICAL', $stats['CRITICAL']],
                ['HIGH', $stats['HIGH']],
                ['MEDIUM', $stats['MEDIUM']],
                ['LOW', $stats['LOW']],
                ['UNKNOWN', $stats['UNKNOWN']],
            ]
        );

        return Command::SUCCESS;
    }

    private function getSeverityColor(?string $severity): string
    {
        return match ($severity) {
            'CRITICAL' => 'red',
            'HIGH' => 'yellow',
            'MEDIUM' => 'blue',
            'LOW' => 'green',
            default => 'white',
        };
    }

    private function truncateText(string $text, int $length): string
    {
        if (strlen($text) <= $length) {
            return $text;
        }
        return substr($text, 0, $length) . '...';
    }

    private function calculateStats(array $cves): array
    {
        $stats = [
            'CRITICAL' => 0,
            'HIGH' => 0,
            'MEDIUM' => 0,
            'LOW' => 0,
            'UNKNOWN' => 0,
        ];

        foreach ($cves as $cve) {
            $severity = $cve['severity'] ?? 'UNKNOWN';
            if (isset($stats[$severity])) {
                $stats[$severity]++;
            } else {
                $stats['UNKNOWN']++;
            }
        }

        return $stats;
    }
}
